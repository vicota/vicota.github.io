<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge"> -->

    <!-- <link rel="stylesheet" href="http://code.jquery.com/ui/1.8.18/themes/base/jquery-ui.css" type="text/css" media="all" /> -->
    <!-- <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css"> -->

    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> -->

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">


</head>
    <body>
        <nav class="mb-4 navbar navbar-dark bg-dark navbar-expand-lg navbar-light bg-light">
            <div class="xw-50 container">
                <a class="navbar-brand" href="/">Memory Mapping</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                    <div class="navbar-nav">
                        <!-- <a class="nav-item nav-link " href="/cord/new_release">New Release</a> -->
                        <!-- <a class="nav-item nav-link " href="/cord">Release Info</a> -->
                        <!-- <a class="nav-item nav-link " href="/cci">Integration</a> -->
                    </div>

                </div>
            </div>
        </nav>
        <div class="xw-75 container small">

<style>
.xrow:hover
{
    /* cursor:move; */
    background-color: #f7f7f7;
}

.handle
{
    cursor:move;
}

.form-control:focus
{
    box-shadow: none;
}

</style>
<div id="memory_tbl" class="p-0 border-0">
    <ul id="memory_top" class="list-group xbg-light px-2 pt-1 pb-2 border bg-light border-bottom-0">
        <li class="xmemory_row xborder-0 p-0 list-group-item mt-1 border-secondary">
    <div class="input-group mt-0">
        <span style="width: 3%" class="shadow-sm py-0 px-2 border-light bg-light input-group-text">
            <input class="memory_row_fxd_all shadow-sm p-0 m-0 border-secondary form-check-input" type="checkbox" value="" aria-label="fixed" tabindex="-1">
        </span>
        <span style="width: 3%" class="xmemory_row_idx shadow-sm py-0 border-light bg-light input-group-text">#</span>
        <input style="width: 48%" desc="-1" class="xmemory_row_dsc shadow-sm py-0 border-light bg-light form-control fw-bold" tabindex="-1" value="Memory Description" placeholder="desc" aria-label="desc" aria-describedby="basic-addon2" readonly>
        <input style="width: 16%" addr="-1" class="xmemory_row_adr shadow-sm py-0 border-light bg-light form-control fw-bold" tabindex="-1" value="Memory Address" placeholder="addr" aria-label="addr" aria-describedby="basic-addon2" readonly>
        <input style="width: 16%" size="-1" class="xmemory_row_siz shadow-sm py-0 border-light bg-light form-control fw-bold" tabindex="-1" value="Memory Size" placeholder="size" aria-label="size" aria-describedby="basic-addon2" readonly>
        <span style="width: 12%" class="shadow-sm py-0 px-2 border-light bg-light input-group-text fw-bold">Controls</span>
    </div>
</li>
    </ul>
    <ul id="memory_dat" class="list-group xbg-light px-2 pt-1 pb-2 border">

<li class="memory_row xborder-0 p-0 list-group-item mt-1">
    <div class="input-group mt-0">
        <span style="width: 3%" class="shadow-sm py-0 px-2 border-light bg-light input-group-text">
            <input class="memory_row_fxd shadow-sm p-0 m-0 border-secondary form-check-input" type="checkbox" value="" aria-label="fixed" tabindex="-1">
        </span>
        <span style="width: 3%" class="memory_row_idx shadow-sm py-0 border-light bg-light input-group-text">1</span>
        <input style="width: 48%" desc="-1" class="memory_row_dsc shadow-sm py-0 border-light bg-white form-control" placeholder="desc" aria-label="desc" aria-describedby="basic-addon2">
        <input style="width: 16%" addr="-1" class="memory_row_adr shadow-sm py-0 border-light bg-white form-control" placeholder="addr" aria-label="addr" aria-describedby="basic-addon2">
        <input style="width: 16%" size="-1" class="memory_row_siz shadow-sm py-0 border-light bg-white form-control" placeholder="size" aria-label="size" aria-describedby="basic-addon2">
        <button style="width: 3%" class="memory_row_cpy shadow-sm py-0 px-2 border-light bg-light btn xbtn-xs xbtn-outline-light text-dark" type="button" tabindex="-1"><i class="bi bi-exclamation-square"></i></button>
        <button style="width: 3%" class="memory_row_add shadow-sm py-0 px-2 border-light bg-light btn xbtn-xs xbtn-outline-light text-dark" type="button" tabindex="-1"><i class="bi bi-plus-square"></i></button>
        <button style="width: 3%" class="memory_row_del shadow-sm py-0 px-2 border-light bg-light btn xbtn-xs xbtn-outline-light text-dark" type="button" tabindex="-1"><i class="bi bi-x-square"></i></i></button>
        <button style="width: 3%" class="memory_row_drg shadow-sm py-0 px-2 border-light bg-light btn xbtn-xs xbtn-outline-light text-dark" type="button" tabindex="-1"><i class="bi bi-puzzle"></i></button>
    </div>
</li>


    </ul>
</div>

<div class="text-center">
    <div class="btn-group btn-group-xs mr-2" role="group" aria-label="End controls group">
        <button type="button" class="memory_row_cpy_end xbtn btn-outline-secondary border-0 m-2" tabindex="-1"><i class="bi bi-exclamation-square"> Clone</i></button>
        <button type="button" class="memory_row_add_end xbtn btn-outline-secondary border-0 m-2" tabindex="-1"><i class="bi bi-plus-square"></i> Add</button>
        <button type="button" class="memory_row_del_end xbtn btn-outline-secondary border-0 m-2" tabindex="-1"><i class="bi bi-x-square"></i></i> Delete</button>
        <button type="button" class="memory_row_upd_map xbtn btn-outline-secondary border-0 m-2" tabindex="-1"><i class="bi bi-check-square"></i></i> Update</button>
    </div>
</div>

<div class="xtext-center mt-3" id="errs">
</div>

<ul id="row_template" class="invisible">

<li class="memory_row xborder-0 p-0 list-group-item mt-1">
    <div class="input-group mt-0">
        <span style="width: 3%" class="shadow-sm py-0 px-2 border-light bg-light input-group-text">
            <input class="memory_row_fxd shadow-sm p-0 m-0 border-secondary form-check-input" type="checkbox" value="" aria-label="fixed" tabindex="-1">
        </span>
        <span style="width: 3%" class="memory_row_idx shadow-sm py-0 border-light bg-light input-group-text">1</span>
        <input style="width: 48%" desc="-1" class="memory_row_dsc shadow-sm py-0 border-light bg-white form-control" placeholder="desc" aria-label="desc" aria-describedby="basic-addon2">
        <input style="width: 16%" addr="-1" class="memory_row_adr shadow-sm py-0 border-light bg-white form-control" placeholder="addr" aria-label="addr" aria-describedby="basic-addon2">
        <input style="width: 16%" size="-1" class="memory_row_siz shadow-sm py-0 border-light bg-white form-control" placeholder="size" aria-label="size" aria-describedby="basic-addon2">
        <button style="width: 3%" class="memory_row_cpy shadow-sm py-0 px-2 border-light bg-light btn xbtn-xs xbtn-outline-light text-dark" type="button" tabindex="-1"><i class="bi bi-exclamation-square"></i></button>
        <button style="width: 3%" class="memory_row_add shadow-sm py-0 px-2 border-light bg-light btn xbtn-xs xbtn-outline-light text-dark" type="button" tabindex="-1"><i class="bi bi-plus-square"></i></button>
        <button style="width: 3%" class="memory_row_del shadow-sm py-0 px-2 border-light bg-light btn xbtn-xs xbtn-outline-light text-dark" type="button" tabindex="-1"><i class="bi bi-x-square"></i></i></button>
        <button style="width: 3%" class="memory_row_drg shadow-sm py-0 px-2 border-light bg-light btn xbtn-xs xbtn-outline-light text-dark" type="button" tabindex="-1"><i class="bi bi-puzzle"></i></button>
    </div>
</li>


</ul>


        </div>

        <!-- <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script> -->
        <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> -->

        <!-- <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js" type="text/javascript"></script> -->
        <!-- <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script> -->

        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>

        <script src="https://unpkg.com/sortablejs-make/Sortable.min.js"></script>
        <script src="https://code.jquery.com/jquery-2.2.4.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/jquery-sortablejs@latest/jquery-sortable.js"></script>


<script>
    function updatemap()
{
    var cont = true;
    var prv_addr = -1;
    var prv_size = 0;
    var rnum = 1;

    $("#memory_dat .memory_row").each(function()
    {
        var ob_rnum = $(this).find("span.memory_row_idx");
        var ob_fixd = $(this).find("input.memory_row_fxd");
        var ob_addr = $(this).find("input.memory_row_adr");
        var ob_size = $(this).find("input.memory_row_siz");
        var addr = parseInt(ob_addr.attr("addr").replaceAll("_", ""));
        var size = parseInt(ob_size.attr("size").replaceAll("_", ""));

        // console.log("ob_fixd: " + ob_fixd.prop("checked"));
        // console.log("ob_rnum: " + rnum + "--" + ob_rnum.text());

        ob_rnum.text(rnum);
        rnum += 1;

        if(ob_fixd.prop("checked"))
        {
            cont = true;
            prv_addr = -1;
            prv_size = 0;
        }

        if((cont == false) || (addr < 0) || (size < 0))
        {
            cont = false;
        }

        if(cont == true)
        {
            // console.log(cont + "--" + addr + "--" + size);

            if(prv_addr >= 0)
            {
                addr = prv_addr + prv_size;
                ob_addr.val(padaddr(addr));
                ob_addr.attr("addr", tohex(addr));
            }

            prv_addr = addr;
            prv_size = size;
        }
    });

    return findoverlap();
}

function findoverlap()
{
    var prv_addr = -1;
    var prv_size = 0;
    var db = [];
    var errors = []

    $("#memory_dat .memory_row").each(function()
    {
        var ob_fixd = $(this).find("input.memory_row_fxd");
        var ob_addr = $(this).find("input.memory_row_adr");
        var ob_size = $(this).find("input.memory_row_siz");
        var addr = parseInt(ob_addr.attr("addr").replaceAll("_", ""));
        var size = parseInt(ob_size.attr("size").replaceAll("_", ""));
        var obj =
        {
            "fixd": ob_fixd.prop("checked"),
            "addr": addr,
            "size": size,
        };

        db.push(obj);
    });

    // console.log(db);

    for(let i = 0; i < db.length; i++)
    {
        for(let j = i + 1; j < db.length; j++)
        {
            var flag = false;
            var ai = db[i]["addr"];
            var si = db[i]["size"];
            var aj = db[j]["addr"];
            var sj = db[j]["size"];

            if((ai <= aj) && (aj < (ai + si)))
            {
                flag = true;
            }
            else if((ai > aj) && (ai < (aj + sj)))
            {
                flag = true;
            }

            if(flag == true)
            {
                errors.push("Error!!! overlap found - row:" + (i + 1) + " row:" + (j + 1));
                // console.log("Error!!! ai:" + ai + " si:" + si + " aj:" + aj + " sj:" + sj);
            }
        }
    }

    // console.log("findoverlap errors: " + errors);

    return errors;
}

    function ishex(s)
{
    var re = /^0[xX][0-9A-Fa-f]{1,16}$/g;
    return re.test(s);
}

function isdec(s)
{
    var re = /[0-9]{1,16}/g;
    return re.test(s);
}

function issizeunit(s)
{
    var re = /[kKmMgG]?[bB]/g;
    return re.test(s);
}

function tohex(intv)
{
    return "0x" + intv.toString(16);
}

function padaddr(addr)
{
    var xstr = ("0000000000" + addr.toString(16)).substr(-9,9);
    xstr = xstr.substr(-9,1) + "_" + xstr.substr(-8,4) + "_" + xstr.substr(-4,4);
    xstr = "0x" + xstr.toUpperCase();
    return xstr;
}

function getaddr(s)
{
    var addr = -1;
    var s0 = s.replaceAll("_", "");

    // console.log("getaddr  s: " + s);
    // console.log("getaddr s0: " + s0);

    if(ishex(s0))
    {
        addr = parseInt(s0);

        if(isNaN(addr))
        {
            addr = -1;
        }
    }

    return addr;
}

function getsize(s)
{
    var ar = s.split(" ");
    var ar0 = null
    var ar1 = null
    var size = -1;

    ar0 = ar[0].replaceAll("_", "");

    if(ar[1] != null)
    {
        ar1 = ar[1].replaceAll("_", "");
    }

    if(ishex(ar0) || isdec(ar0))
    {
        var size = parseInt(ar0);

        if(issizeunit(ar1))
        {
            switch(ar1.toLowerCase())
            {
                case "b": size = size; break;
                case "kb": size = size * 1024; break;
                case "mb": size = size * 1024 * 1024; break;
                case "gb": size = size * 1024 * 1024 * 1024; break;
                default: size = 0; break;
            }

            return size;
        }
        else if(ar1 == null)
        {
            size = size;
        }
    }

    return size;
}

function issize(s)
{
    if(getsize(s) >= 0)
    {
        return true;
    }

    return false;
}

function disperrors(errs)
{
    var ob_errs = $("#errs");
    var html = "";

    if((errs != null) && (errs.length > 0))
    {
        html += "<ol class='list-group list-group-numbered'>";

        for(let i = 0; i < errs.length; i++)
        {
            // console.log("disperrors errs: " + i + "-" + errs[i]);
            html += "<li class='list-group-item list-group-item-danger'>" + errs[i] + " </li>";
        }

        html += "</ol>";
    }

    ob_errs.html(html);
}

function refresh()
{
    errs = updatemap();
    disperrors(errs);
}

    $(document).ready(function($)
{
    // https://codewithmark.com/how-to-easily-add-and-delete-rows-of-a-html-table-with-jquery-dynamically
    //--->add row at the end > start
    $(document).on('click',".memory_row_cpy_end", function(e)
    {
        // console.log("memory_row_cpy_end");
        var tableBody = $(document).find('#memory_dat');
        var trLast = tableBody.find(".memory_row").last();
        if(trLast.html())
        {
            trLast.after(trLast.clone());
        }
        else
        {
            tableBody.html($("#row_template").html());
        }
        refresh();
    });
    $(document).on('click',".memory_row_add_end", function(e)
    {
        // console.log("memory_row_add_end");
        var tableBody = $(document).find('#memory_dat');
        var trLast = tableBody.find(".memory_row").last();
        if(trLast.html())
        {
            trLast.after($("#row_template").html());
        }
        else
        {
            tableBody.html($("#row_template").html());
        }
        refresh();
    });
    $(document).on('click',".memory_row_del_end", function(e)
    {
        // console.log("memory_row_del_end");
        var tableBody = $(document).find('#memory_dat');
        var trLast = tableBody.find(".memory_row").last();
        trLast.remove();
        refresh();
    });
    $(document).on('click',".memory_row_upd_map", function(e)
    {
        // console.log("memory_row_upd_map");
        refresh();
    });
    //--->add row at the end > end
    //--->current row > new > start
    $(document).on('click',".memory_row_add", function(e)
    {
        var r = $(this).closest('.memory_row').clone();
        $(this).closest('.memory_row').after($("#row_template").html());
        refresh();
    });
    //--->current row > new > end
    //--->current row > clone > start
    $(document).on('click',".memory_row_cpy", function(e)
    {
        var r = $(this).closest('.memory_row').clone();
        $(this).closest('.memory_row').after(r);
        refresh();
    });
    //--->current row > clone > end
    //--->current row > delete > start
    $(document).on('click',".memory_row_del", function(e)
    {
        var r = $(this).closest('.memory_row').remove();
        refresh();
    });
    $(document).on('click',"input.memory_row_fxd", function(e)
    {
        // console.log("memory_row_fxd: " + $(this).prop("checked"));

        if($(this).prop("checked"))
        {
            // console.log($(this).closest('.memory_row').next().html());
            // console.log($(this).closest('.memory_row').next().next().html());

            // var cur = $(this).closest('.memory_row');

            // var r = cur.clone();
            // r.find(".memory_row_fxd").prop("disabled", true);
            // r.find(".memory_row_cpy").prop("disabled", true);
            // r.find(".memory_row_add").prop("disabled", true);
            // r.find(".memory_row_del").prop("disabled", true);
            // r.find(".memory_row_drg").prop("disabled", true);

            // var x = cur.clone();
            // x.find(".memory_row_fxd").prop("disabled", true);
            // x.find(".memory_row_cpy").prop("disabled", true);
            // x.find(".memory_row_add").prop("disabled", true);
            // x.find(".memory_row_del").prop("disabled", true);
            // x.find(".memory_row_drg").prop("disabled", true);

            // cur.after(r);
            // cur.after(x);

            // c.find(".memory_row_fxd").prop("disabled", true);
            // c.find(".memory_row_cpy").prop("disabled", true);
            // c.find(".memory_row_add").prop("disabled", true);
            // c.find(".memory_row_del").prop("disabled", true);
            // c.find(".memory_row_drg").prop("disabled", true);

            $(this).closest('.memory_row').addClass("bg-light");
        }
        else
        {
            $(this).closest('.memory_row').removeClass("bg-light");
        }
    });
    $(document).on('click',"input.memory_row_fxd_all", function(e)
    {
        if($(this).prop("checked"))
        {
            $('#memory_tbl .memory_row').each(function()
            {
                $(this).find("input.memory_row_fxd").prop("checked", true);
            });
        }
        else
        {
            $('#memory_tbl .memory_row').each(function()
            {
                $(this).find("input.memory_row_fxd").prop("checked", false);
            });
        }
    });
    $(document).on('dblclick',"input", function(e)
    {
        if($(this).hasClass("memory_row_fxd") == false)
        {
            $(this).addClass("bg-light");
            $(this).addClass("flag_dblclick");
            $(this).focus();
        }
    });
    $(document).on('focusout',"input", function(e)
    {
        if($(this).hasClass("memory_row_fxd") == false)
        {
            var flag_memmap_update = false;

            $(this).removeClass("bg-light");
            $(this).removeClass("flag_dblclick");

            if($(this).hasClass("memory_row_adr"))
            {
                var addr = getaddr($(this).val());
                // console.log("addr: " + addr);

                if(addr < 0)
                {
                    $(this).removeClass("border-0");
                    $(this).addClass("bg-warning");
                    $(this).removeClass("bg-white");
                    $(this).attr("addr", addr);
                }
                else
                {
                    $(this).addClass("border-0");
                    $(this).removeClass("bg-warning");
                    $(this).addClass("bg-white");
                    $(this).val(padaddr(addr));
                    $(this).attr("addr", addr);
                    flag_memmap_update = true;
                }

                // console.log("flag_memmap_update: " + flag_memmap_update);
            }
            else if($(this).hasClass("memory_row_siz"))
            {
                var size = getsize($(this).val());
                // console.log(size);

                if(size < 0)
                {
                    $(this).removeClass("border-0");
                    $(this).addClass("bg-warning");
                    $(this).removeClass("bg-white");
                    $(this).attr("size", size);
                }
                else
                {
                    $(this).addClass("border-0");
                    $(this).removeClass("bg-warning");
                    $(this).addClass("bg-white");
                    $(this).attr("size", size);
                    flag_memmap_update = true;
                }
            }

            if(flag_memmap_update)
            {
                refresh();
            }
        }
    });
    //--->current row > delete > end
    //--->sortable
    $('#memory_dat').sortable({
        animation: 200,
        ghostClass: 'ghost',
        sort: true,
        handle: '.memory_row_drg',
        // start: function()
        // {
        //     console.log("start")
        // },
        // stop: function(){
        //     console.log("stop")
        // },
        onSort: function reportActivity()
        {
            // console.log('The sort order has changed');
            refresh();
        }
        // update: function( event, ui )
        // {
        //     $(this).children().each(function(index) {
        //         $(this).find('td').last().html(index + 1)
        //     });
        // }
    });
});

</script>

    </body>
</html>
